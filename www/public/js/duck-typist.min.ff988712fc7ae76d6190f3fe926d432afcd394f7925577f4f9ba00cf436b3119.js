const QUACK=new Audio("quack.wav"),MIN_PRECISION=98,MIN_CPM_SPEED=100,MIN_WIN_STREAK=5,STARTING_LEVEL=4,MIN_WORD_COUNT=42,ALL_30_KEYS=["KeyF","KeyJ","KeyD","KeyK","KeyS","KeyL","KeyA","Semicolon","KeyE","KeyI","KeyW","KeyO","KeyV","KeyM","KeyG","KeyH","KeyQ","KeyP","KeyR","KeyU","KeyT","KeyY","KeyB","KeyN","KeyC","Comma","KeyX","Period","KeyZ","Slash"];window.addEventListener("DOMContentLoaded",()=>{"use strict";const s=document.querySelector("x-keyboard"),h=document.querySelector("#geometry"),n=document.querySelector("#layout"),u=document.querySelector("#dict"),y=document.querySelector(".key_list"),C=document.querySelector(".status"),d=document.querySelector(".quacks"),a=document.querySelector("#lesson"),g=document;let l=void 0,c={words:void 0,trigrams:void 0,bigrams:void 0},i=[],e=void 0,r=void 0,o=void 0,t=void 0,f=!1;const x=()=>{const e=u.value.split(",")[0];return fetch(`../corpus/${e}.json`).then(e=>e.json()).then(e=>{c.trigrams=Object.keys(e.trigrams),c.bigrams=Object.keys(e.digrams)})},O=()=>{const e=u.value.split(",")[1];return fetch(`./${e}.json`).then(e=>e.json()).then(e=>{c.words=e.words})},k=()=>fetch(`../layouts/${n.value}.json`).then(e=>e.json()).then(e=>{s.setKeyboardLayout(e.keymap,e.deadkeys,h.value),s.theme="hints",l=e}),m=()=>{localStorage.setItem(`${n.value}.level`,o);const e=ALL_30_KEYS.slice(0,o),t=e.map(e=>l.keymap[e][0]),h=e.flatMap(e=>l.keymap[e]),s=l.deadkeys["**"],a=e.some(e=>l.keymap[e].indexOf("**")>=0),r=a?t.filter(e=>e in s).map(e=>s[e]):[],d=t.concat(r),u=e=>Array.from(e).every(e=>d.indexOf(e)>=0);i=[];for(const e of[c.words,c.trigrams,c.bigrams,t])if(i=i.concat(e.filter(u)),i.length>MIN_WORD_COUNT)break;p(),j(),E()},E=()=>{const e=e=>e>=0&&e<o,t=(t,n)=>{const s=l.keymap[t][0],o=s==="**"?"â˜…":s.slice(-1),i=e(n)?"":"inactive";return`<kbd data-level="${n+1}" class="${i}">${o}</kbd>`};y.innerHTML=ALL_30_KEYS.map(t).join(""),s.keys.forEach(t=>{t.style.opacity=e(ALL_30_KEYS.indexOf(t.id))?1:.5})},j=()=>{if(r=void 0,a.innerHTML="",i.length===0)return;let t="";for(;t.length<120;)t+=i[i.length*Math.random()|0]+" ";a.innerHTML=Array.from(t.slice(0,-1)).map(e=>e==" "?'<span class="space"></span>':`<span>${e}</span>`).join(""),e=a.firstElementChild,e.id="current",f=!1},_=t=>{if(!e)return;const n=e.innerText===t||t===" "&&e.innerText==="";if(!n&&!r)return;n?(e.classList.add(f?"fixed":"done"),e.id="",e=e.nextSibling,f=!1):(e.classList.add("error"),f=!0),r||(r=performance.now(),C.innerText="â€¦"),e?e.id="current":(A(performance.now()),r=void 0)},A=e=>{const t=(e-r)/6e4,i=a.querySelectorAll(".error").length,c=a.querySelectorAll(".space").length+1,n=a.children.length,s=Math.round(n/t),l=Math.round(c/t),o=100-Math.round(1e3*i/n)/10;C.innerText=`${l}â€¯wpm, ${s}â€¯cpm, ${o}â€¯%`,s>=MIN_CPM_SPEED&&o>=MIN_PRECISION?w():S()},w=()=>{QUACK.play(),t++,p(),t>=MIN_WIN_STREAK?(o=2*(Math.floor(o/2)+1),t=1,d.parentNode.classList.add("active"),setTimeout(m,500)):setTimeout(j,500)},S=()=>{t=Math.max(1,t-1),p(),setTimeout(j,500)},p=()=>{localStorage.setItem(`${n.value}.quacks`,t),d.parentNode.classList.remove("active"),d.innerText=Array(t).fill("ðŸ¦†").join("")};d.addEventListener("transitionend",p),d.addEventListener("dblclick",w);const b=()=>{const e=window.location.hash.slice(1),s=localStorage.getItem("dict"),i=localStorage.getItem("geometry"),a=localStorage.getItem(`${n.value}.level`),r=localStorage.getItem(`${n.value}.quacks`);e&&(n.value=e),s&&(u.value=s),i&&(h.value=i),o=a?Number(a):STARTING_LEVEL,t=r?Number(r):1,window.location.hash=`#${n.value}`,Promise.all([x(),O(),k()]).then(m)};window.addEventListener("hashchange",b),n.addEventListener("change",b),u.addEventListener("change",()=>{localStorage.setItem("dict",u.value),Promise.all([x(),O()]).then(m)}),h.addEventListener("change",e=>{localStorage.setItem("geometry",h.value),s.geometry=h.value}),y.addEventListener("click",e=>{e.target.nodeName.toLowerCase()=="kbd"&&(o=e.target.dataset.level,m())}),b();const v={};g.onkeydown=e=>{v[e.code]=!0;const t=s.keyDown(e);if(t)_(t);else return!0;return!1},g.addEventListener("keyup",e=>{v[e.code]?(s.keyUp(e),delete v[e.code]):(_(e.value),setTimeout(()=>s.keyUp(e),100))}),g.addEventListener("input",e=>{(e.inputType==="insertCompositionText"||e.inputType==="insertText")&&(e.target.value=e.target.value.slice(0,-e.data.length))})})