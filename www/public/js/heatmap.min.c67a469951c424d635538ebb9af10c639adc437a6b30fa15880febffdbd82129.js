window.addEventListener("DOMContentLoaded",()=>{"use strict";const u=document.querySelector("input"),t=document.querySelector("x-keyboard");let n={},s={},i={},a={},p="",o=!1;const b={" ":" "," ":" ","«":'"',"»":'"',"“":'"',"”":'"',"„":'"',"‘":"'","’":"'","–":"-","—":"-","…":"..."},v=(e,t)=>{const n={},s={};return Object.entries(e).forEach(([e,t])=>{t.forEach(t=>{t in n||(t.length===1?n[t]=[e]:t in s||(s[t]=e))})}),Object.entries(t).forEach(([e,t])=>{Object.entries(t).forEach(([t,o])=>{!(o in n)&&n[t]&&(n[o]=[s[e]].concat(n[t]))})}),n},d=(e,t)=>`${Math.round(10**t*e)/10**t}%`,e=(e,t,n,s)=>{const o=s?document.querySelector(s).shadowRoot:document;o.querySelector(e).innerText=d(t,n)},l=(e,t,n,s)=>{const i=document.querySelector(`${e} canvas`),h=document.querySelector(`${e} table`);i.width=1e3,i.height=100;const a=i.getContext("2d");a.save();const m=getComputedStyle(document.querySelector("h1")).getPropertyValue("color");a.fillStyle=o?m:"#88f";const r=i.width/11,c=20,l=100/n;let u="";Object.values(t).forEach((e,t)=>{const n=t>=4?t+2:t+1;u+=(t===4?"<td></td>":"")+`<td>${d(e,s)}</td>`,a.fillRect(n*r+c/2,i.height-e*l,r-c/2,e*l)}),a.restore(),h.innerHTML=`<tr><td></td>${u}<td></td></tr>`},h=()=>{const r={},a={},b={},v={},f={},m={},c={},h={},y=["l5","l4","l3","l2","r2","r3","r4","r5"];y.forEach(e=>{a[e]=0,r[e]=0});const u={};Object.entries(t.fingerAssignments).forEach(([e,t])=>{t.forEach(t=>{u[t]=e})});const d=e=>Array.from("TGBNHY").some(t=>t==e.at(3))||!e.startsWith("Key")&&!["Space","Comma","Period","Slash","Semicolon"].includes(e),s=e=>{if(e==="Space")return 0;if(e.startsWith("Digit"))return 4;if(e.startsWith("Key")){const t=e.at(3);if(Array.from("QWERTYUIOP").indexOf(t)>=0)return 3;if(Array.from("ASDFGHJKL").indexOf(t)>=0)return 2;if(Array.from("ZXCVBNM").indexOf(t)>=0)return 1}return["Backquote","Minus"].some(t=>t==e)?4:["BracketLeft","BracketRight"].some(t=>t==e)?3:["Semicolon","Quote","Backslash"].some(t=>t==e)?2:["Comma","Period","Slash","IntlBackslash"].some(t=>t==e)?1:(console.error(`Unknown Key Row: ${e}`),0)},w=(e,t,n,o)=>{var i=s(e),a=s(t);switch(n.at(1)+o.at(1)){case"45":[i,a]=[a,i];case"54":return Math.abs(s(e)-s(t))>=1&&(i!=2||a!=3);default:return Math.abs(s(e)-s(t))>=2}},j=(e,t)=>e+t,_=Object.values(i).reduce(j,0);Object.entries(i).map(([e,t])=>[e,100*t/_]).forEach(([e,n])=>{t.layout.getKeySequence(e).reduce((t,s)=>{const o=u[s.id],i=u[t];return!o||!i?s.id:(t===s.id?(b[e]=n,r[o]+=n):o===i?(v[e]=n,a[o]+=n):o[0]===i[0]&&(w(s.id,t,o,i)?(h[e]=n,(d(s.id)||d(t))&&(c[e]=n)):d(s.id)||d(t)?c[e]=n:o[1]<i[1]?f[e]=n:m[e]=n),s.id)},"")}),document.querySelector("#imprecise-data").style.display=o?"block":"none";const n=e=>Object.values(e).reduce(j,0);l("#sfu",a,3.5,2),l("#sku",r,3.5,2),e("#sfu-all",n(a),2),e("#sku-all",n(r),2),e("#sfu-all",n(a),2,"#Achoppements"),e("#extensions-all",n(c),2,"#Achoppements"),e("#scisors-all",n(h),2,"#Achoppements"),e("#inward-all",n(f),1,"#Digrammes"),e("#outward-all",n(m),1,"#Digrammes"),e("#sku-all",n(r),2,"#Digrammes");const g=document.getElementById("Achoppements");g.updateTableData("#sfu-digrams","SFU",v,2),g.updateTableData("#extended-rolls","extensions",c,2),g.updateTableData("#scisors","ciseaux",h,2);const p=document.getElementById("Digrammes");p.updateTableData("#sku-digrams","SKU",b,2),p.updateTableData("#inward","rolls intérieur",f,2),p.updateTableData("#outward","rolls extérieur",m,2)},m=()=>{const o={},i={},r={},c={},l={Space:"th"};Object.entries(t.fingerAssignments).forEach(([e,t])=>{t.forEach(t=>{l[t]=e})});const n=(e,t)=>e+t,d=Object.values(a).reduce(n,0);Object.entries(a).map(([e,t])=>[e,100*t/d]).forEach(([e,n])=>{const s=t.layout.getKeySequence(e),a=s.map(e=>l[e.id]??"  "),d=a.map(e=>e.charAt(0)).join("");if(a[0]==a[2]){for(let t=0;t<s.length-2;t++)if(s[t].id==s[t+2].id){r[e]=n;return}c[e]=n;return}if(d==="lll"||d==="rrr"){const t=a.map(e=>Number(e.charAt(1)));(t[0]<t[1]&&t[1]>t[2]||t[0]>t[1]&&t[1]<t[2])&&(t.some(e=>e==2)?o[e]=n:i[e]=n)}}),e("#almost-skb-all",Object.values(r).reduce(n,0),1,"#Trigrammes"),e("#almost-sfb-all",Object.values(c).reduce(n,0),1,"#Trigrammes"),e("#redirect-all",Object.values(o).reduce(n,0),1,"#Trigrammes"),e("#bad-redirect-all",Object.values(i).reduce(n,0),2,"#Trigrammes");const s=document.getElementById("Trigrammes");s.updateTableData("#almost-skbs","presque SKBs",r,2),s.updateTableData("#almost-sfbs","presque SFBs",c,2),s.updateTableData("#redirect","redirections",o,2),s.updateTableData("#bad-redirect","redirections foireuses",i,2)},f=()=>{const i={};Object.values(n).forEach(e=>{e.forEach(e=>{i[e]=0})});const a={};Object.entries(s).forEach(([e,t])=>{const s=n[e]||n[b[e]];s?s.forEach(e=>{i[e]+=t}):a[e]=t});const r=Object.values(a).reduce((e,t)=>e+t,0).toFixed(3);o=r>=.5;const u={},f=6,p=Object.values(s).reduce((e,t)=>t+e,0),g=getComputedStyle(document.querySelector("h1")).getPropertyValue("color").slice(0,-1);Object.keys(t.layout.keyMap).forEach(e=>{if(e!=="Enter"){const n=e in i?i[e]:0,t=f*n/p;u[e]=o?g+`, ${t})`:`rgb(127, 127, 255, ${t})`}}),t.setCustomColors(u);const c={},d={};let h=0;Object.entries(t.fingerAssignments).forEach(([e,t])=>{c[e]=t.filter(e=>e in i).reduce((e,t)=>e+i[t],0),h+=c[e]}),Object.entries(c).forEach(([e,t])=>{d[e]=100*t/h});const m=(e,t)=>d[t]+e;e("#load-left",["l2","l3","l4","l5"].reduce(m,0),1),e("#load-right",["r2","r3","r4","r5"].reduce(m,0),1),e("#unsupported-all",r,3,"#Achoppements"),l("#load",d,25,1,r>=.5),document.getElementById("Achoppements").updateTableData("#unsupported","non-supporté",a,3)},c=["layout","geometry","corpus"],j=(e,o)=>{e==="layout"?o?fetch(`../layouts/${o}.json`).then(e=>e.json()).then(e=>{u.placeholder=`Zone de saisie ${o}`,t.setKeyboardLayout(e.keymap,e.deadkeys,e.geometry.replace("ergo","iso")),e.keymap.Enter=[``,`
`],n=v(e.keymap,e.deadkeys),Object.keys(s).length>0&&(f(),h(),m())}):(t.setKeyboardLayout(),n={},u.placeholder="select a keyboard layout"):e==="corpus"?o&&o!==p&&(fetch(`../corpus/${o}.json`).then(e=>e.json()).then(e=>{s=e.symbols,i=e.digrams,a=e.trigrams,Object.keys(n).length>0&&(f(),h(),m())}),p=o):t[e]=o,document.getElementById(e).value=o},r={},y=(e,t)=>{r[e]=t,window.location.hash="/"+c.map(e=>r[e]).join("/").replace(/\/+$/,"")},g=()=>{const e=window.location.hash.split("/").slice(1);c.forEach((t,n)=>{j(t,e[n]||""),r[t]=e[n]||""})};c.forEach(e=>{document.getElementById(e).addEventListener("change",t=>y(e,t.target.value))}),window.addEventListener("hashchange",g),g()})